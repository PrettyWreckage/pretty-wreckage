<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Raw Truth | Pretty Wreckage</title>
  <style>
    /* ... your styles remain unchanged ... */
  </style>
</head>
<body>

  <h1>Still Searching, Still Unbroken.</h1>
  <div class="meta">
    Date: 2019-01-28<br>
    Mood: Sadness, Longing, Vulnerability.
  </div>

  <div class="poem-container poem-section" id="poem1-container">
    <pre id="poem-text-1">
I’m all kinds of shattered
a tangle of jagged edges and silent screams,
lost in the ruins of my restless mind,
chasing shadows that slip through my dreams.

... (poem content truncated for space) ...

Because I’m still here,
still broken, still aching
still searching, still hoping,
still waiting for you.
    </pre>
    <button onclick="togglePoem('poem-text-1', this)">Read More</button>

    <div class="like-section">
      <button class="like-button" data-poem="poem1" title="Like this poem">❤️</button>
      <span id="like-count-poem1">0</span> Likes
    </div>

    <div class="comments-section" id="comments-poem1">
      <h3>Comments</h3>
      <div id="comments-list-poem1"></div>
      <form id="comment-form-poem1">
        <input type="text" id="name-poem1" placeholder="Your name" required />
        <textarea id="comment-text-poem1" placeholder="Your comment" required></textarea>
        <button type="submit">Post Comment</button>
      </form>
    </div>
  </div>

  <h1>Fragile Echoes</h1>
  <div class="meta">
    Date: 2019-01-29<br>
    Mood: Fearful, Conflicted, Tender and pleading
  </div>

  <div class="poem-container poem-section" id="poem2-container">
    <pre id="poem-text-2">
I flinch when things go right,
as if safety is a thief in the night.

... (poem content truncated for space) ...

For behind the scars and all my fears,
is a heart that’s longing just to be near.
    </pre>
    <button onclick="togglePoem('poem-text-2', this)">Read More</button>

    <div class="like-section">
      <button class="like-button" data-poem="poem2" title="Like this poem">❤️</button>
      <span id="like-count-poem2">0</span> Likes
    </div>

    <div class="comments-section" id="comments-poem2">
      <h3>Comments</h3>
      <div id="comments-list-poem2"></div>
      <form id="comment-form-poem2">
        <input type="text" id="name-poem2" placeholder="Your name" required />
        <textarea id="comment-text-poem2" placeholder="Your comment" required></textarea>
        <button type="submit">Post Comment</button>
      </form>
    </div>
  </div>

  <a href="categories.html" class="back-button">Back to the Bleeding Pages</a>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAsQTtktHfCVbOGgzL4xs8Q6pkICdRDpnw",
      authDomain: "pretty-wreckage-9c673.firebaseapp.com",
      projectId: "pretty-wreckage-9c673",
      storageBucket: "pretty-wreckage-9c673.firebasestorage.app",
      messagingSenderId: "983710612507",
      appId: "1:983710612507:web:ab92b689d2c823b108ccbe",
      measurementId: "G-EBH6K5923F"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function togglePoem(id, button) {
      const poem = document.getElementById(id);
      const expanded = poem.style.maxHeight === '1000em';
      poem.style.maxHeight = expanded ? '10em' : '1000em';
      button.textContent = expanded ? 'Read More' : 'Collapse';
    }

    function updateLikeCount(poemId, count) {
      document.getElementById('like-count-' + poemId).textContent = count;
    }

    function listenForLikes(poemId) {
      db.collection('likes').doc(poemId).onSnapshot(doc => {
        if(doc.exists) {
          updateLikeCount(poemId, doc.data().count);
        } else {
          db.collection('likes').doc(poemId).set({count: 0});
          updateLikeCount(poemId, 0);
        }
      });
    }

    function likePoem(poemId) {
      const likeRef = db.collection('likes').doc(poemId);
      db.runTransaction(transaction => {
        return transaction.get(likeRef).then(doc => {
          if(!doc.exists) {
            transaction.set(likeRef, {count: 1});
            return 1;
          }
          const newCount = (doc.data().count || 0) + 1;
          transaction.update(likeRef, {count: newCount});
          return newCount;
        });
      }).catch(err => {
        console.error("Failed to increment like: ", err);
      });
    }

    document.querySelectorAll('.like-button').forEach(btn => {
      btn.addEventListener('click', () => {
        const poemId = btn.getAttribute('data-poem');
        likePoem(poemId);
      });
    });

    listenForLikes('poem1');
    listenForLikes('poem2');

    function renderComments(poemId, comments) {
      const list = document.getElementById('comments-list-' + poemId);
      list.innerHTML = '';
      if (comments.length === 0) {
        list.textContent = 'No comments yet. Be the first to comment!';
        return;
      }
      comments.forEach(comment => {
        const div = document.createElement('div');
        div.classList.add('comment');
        div.innerHTML = `<span class="name">${escapeHTML(comment.name)}</span>: <span class="text">${escapeHTML(comment.text)}</span>`;
        list.appendChild(div);
      });
    }

    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, function(m) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[m];
      });
    }

    function listenForComments(poemId) {
      db.collection('comments')
        .where('poemId', '==', poemId)
        .orderBy('timestamp', 'asc')
        .onSnapshot(snapshot => {
          const comments = [];
          snapshot.forEach(doc => {
            comments.push(doc.data());
          });
          renderComments(poemId, comments);
        });
    }

    function addComment(poemId, name, text) {
      return db.collection('comments').add({
        poemId: poemId,
        name: name,
        text: text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    function setupCommentForm(poemId) {
      const form = document.getElementById('comment-form-' + poemId);
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const nameInput = document.getElementById('name-' + poemId);
        const commentInput = document.getElementById('comment-text-' + poemId);
        const name = nameInput.value.trim();
        const comment = commentInput.value.trim();

        if (name && comment) {
          addComment(poemId, name, comment)
            .then(() => {
              nameInput.value = '';
              commentInput.value = '';
            })
            .catch(err => {
              console.error("Error adding comment: ", err);
            });
        }
      });
    }

    listenForComments('poem1');
    listenForComments('poem2');
    setupCommentForm('poem1');
    setupCommentForm('poem2');
  </script>
</body>
</html>
